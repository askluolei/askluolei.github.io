---
title: 线程池常见问题记录
tags:
  - 线程池
  - 面试
categories:
  - 技术笔记
date: 2019-11-22 12:03:26
---


记录一些常见的关于线程池的问题，参考其他看过的资料，总结为自己的答案

## 为什么不推荐使用 Executors 创建线程池  
`Executors` 内部使用的是 `ThreadPoolExecutor`，如果转为直接使用 `ThreadPoolExecutor`, 那么需要使用者了解内部的原理，至少知道几个参数是干嘛的。如果使用 `Executors` 创建，可能不太清楚内部的规则，而导致资源耗尽的异常。

## 线程池的参数有哪些
这里，其实就是问的 `ThreadPoolExecutor` 构造需要哪些参数，当然，`ThreadPoolExecutor` 内部也有几个非构造传入的参数，其中重点参数有
1. corePoolSize 核心线程数
2. maximumPoolSize 最大线程数
3. keepAliveTime 超过核心线程数，最大空闲存活时间
4. unit 上面的单位
5. workQueue 工作队列
6. threadFactory 线程工程，这里注意修改线程名和是否后台线程
7. handler  拒绝策略 `RejectedExecutionHandler` 接口的实现

除了上面的构造参数，还有一个 `allowCoreThreadTimeOut` 是否允许释放核心线程，正常情况下，线程池会维持至少 core 个核心线程，如果配置了这个参数，那么核心线程也会使用 `keepAliveTime` 的配置来释放自己

## 线程池的任务提交流程 
1. 如果线程池中线程的数量 小于 core ，那么创建新的任务线程
2. 如果已经到达了 core 线程，那么丢任务队列 workQueue
3. 如果队列满了，继续新建线程数量 小于 maximumPoolSize （对单个任务来说，只是建一个线程，当然，也可能建不了，因为 core == maximumPoolSize）
4. 如果线程数量达到 maximumPoolSize ，那么使用拒绝策略 `RejectedExecutionHandler`

## 线程池的关闭方法是上面，对正在运行的线程有怎样的影响
关闭方法有两个
1. shutdown
  设置为 `SHUTDOWN` 状态，不再接受新的任务，已有的任务继续执行
2. shutdownNow
  设置为 `STOP` 状态，不再接受新的任务，尝试停止所有正在执行的任务（设置中断），返回还未执行的任务队列


## 线程池有哪些拒绝策略
拒绝策略是实现 `RejectedExecutionHandler` 接口。内部有以下几种实现  
1. AbortPolicy 抛 `RejectedExecutionException` 异常， 这个是默认的
2. DiscardPolicy  啥事也不做，默默的丢到任务
3. DiscardOldestPolicy  丢到队列头部的任务，也就是最老（早）的任务
4. CallerRunsPolicy 直接在调用线程执行任务

